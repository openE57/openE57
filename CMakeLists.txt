# This is an update version of  the CMake project file for the libe57 reference
# implementation, with support for Conan targets, to make the dependency
# management easier and reproducible on all the supported platforms
#
# Original   work Copyright 2010-2012   Roland Schwarz, Riegl LMS GmbH
# Modified work Copyright 2020         Michele Adduci <adduci@tutanota.com>
#
# Permission is hereby granted, free of charge, to any person or organization
# obtaining a copy of the software and accompanying documentation covered by
# this license (the "Software") to use, reproduce, display, distribute, execute,
# and transmit the Software, and to prepare derivative works of the Software,
# and to permit third-parties to whom the Software is furnished to do so, all
# subject to the following:
#
# The copyright notices in the Software and this entire statement, including the
# above license grant, this restriction and the following disclaimer, must be
# included in all copies of the Software, in whole or in part, and all
# derivative works of the Software, unless such copies or derivative works are
# solely in the form of machine-executable object code generated by a source
# language processor.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT
# SHALL THE COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE FOR
# ANY DAMAGES OR OTHER LIABILITY, WHETHER IN CONTRACT, TORT OR OTHERWISE,
# ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
# DEALINGS IN THE SOFTWARE.
#
# Requirements: 
# * Xerces library: http://xerces.apache.org/ 
# * Boost library: http://www.boost.org
#
# Notes: Since there is not standard cmake module to find the xerces library we
# provide one with this distribution. It should be able to find the library from
# the XERCES_ROOT cmake variable. Standard layout, as with the binary packages
# from apache is assumed. If you find any errors or have suggestion to improve
# the build script: patches are most welcome!

cmake_minimum_required(VERSION 3.15.0 FATAL_ERROR)

# Enables the MSVC_RUNTIME_LIBRARY property on targets
cmake_policy(SET CMP0091 NEW)

project(openE57 VERSION 1.5.0 LANGUAGES C CXX DESCRIPTION "openE57 is a library for handling e57 files")

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED TRUE)
set(CMAKE_EXPORT_COMPILE_COMMANDS TRUE)
set(CMAKE_SKIP_BUILD_RPATH FALSE)
set(CMAKE_BUILD_WITH_INSTALL_RPATH FALSE)
set(CMAKE_INSTALL_RPATH_USE_LINK_PATH TRUE)
set(CMAKE_INSTALL_PREFIX ${CMAKE_BINARY_DIR}/redist-${PROJECT_NAME}-v${PROJECT_VERSION})
list(FIND CMAKE_PLATFORM_IMPLICIT_LINK_DIRECTORIES "${CMAKE_INSTALL_PREFIX}/lib" isSystemDir)
if("${isSystemDir}" STREQUAL "-1")
    set(CMAKE_INSTALL_RPATH "${CMAKE_INSTALL_PREFIX}/lib")
endif("${isSystemDir}" STREQUAL "-1")

option(BUILD_EXAMPLES "Build e57 examples" FALSE)
option(BUILD_TOOLS "Build e57 tools" FALSE)
option(BUILD_TESTS "Build e57 tests" FALSE)
option(BUILD_SHARED_LIBS "Build e57 shared libraries" FALSE)
option(BUILD_WITH_MT "Build e57 libraries as MultiThreaded DLL" FALSE)

if(BUILD_SHARED_LIBS)
  message(FATAL_ERROR "Shared Libraries are not supported due to missing exported symbols")
else(BUILD_SHARED_LIBS)
  set(LIBRARY_TYPE STATIC)
endif()

if(EXISTS ${CMAKE_BINARY_DIR}/conanbuildinfo.cmake)
  include(${CMAKE_BINARY_DIR}/conanbuildinfo.cmake)
  conan_basic_setup(TARGETS)
endif()

# Set a private module find path
set(CMAKE_MODULE_PATH ${CMAKE_BINARY_DIR} ${CMAKE_MODULE_PATH} "${CMAKE_SOURCE_DIR}/cmake/Modules/")
set(CMAKE_PREFIX_PATH ${CMAKE_BINARY_DIR} ${CMAKE_PREFIX_PATH})

include(GNUInstallDirs)
include(CMakePackageConfigHelpers)
include(InstallRequiredSystemLibraries)
include(GenerateExportHeader)
include(${CMAKE_SOURCE_DIR}/cmake/compiler_options.cmake)
include(${CMAKE_SOURCE_DIR}/cmake/dependencies.cmake)


set(CONFIG_PACKAGE_INSTALL_DIR lib/cmake/${PROJECT_NAME})

list(APPEND compiler_definitions
  E57_REFIMPL_REVISION_ID=${PROJECT_NAME}-${PROJECT_VERSION})

configure_file("${PROJECT_SOURCE_DIR}/include/config.h.in"
               "${PROJECT_BINARY_DIR}/include/config.h")

#
# The main library 
#
add_library(
  ${PROJECT_NAME} ${LIBRARY_TYPE}
  ${CMAKE_SOURCE_DIR}/src/openE57Simple.cpp
  ${CMAKE_SOURCE_DIR}/src/openE57SimpleImpl.cpp
  ${CMAKE_SOURCE_DIR}/src/openE57.cpp
  ${CMAKE_SOURCE_DIR}/src/openE57Impl.cpp
  ${CMAKE_SOURCE_DIR}/include/openE57/impl/openE57Impl.h
  ${CMAKE_SOURCE_DIR}/include/openE57/impl/openE57SimpleImpl.h
  ${CMAKE_SOURCE_DIR}/include/openE57/openE57.h
  ${CMAKE_SOURCE_DIR}/include/openE57/openE57Simple.h)

generate_export_header(${PROJECT_NAME})
set_target_properties(${PROJECT_NAME} PROPERTIES 
  DEBUG_POSTFIX "-d" 
  MSVC_RUNTIME_LIBRARY "${MSVC_RUNTIME_TYPE}")
target_compile_options(${PROJECT_NAME} PUBLIC ${compiler_options})
target_compile_definitions(${PROJECT_NAME} PUBLIC ${compiler_definitions})
target_link_options(${PROJECT_NAME} PUBLIC ${linker_flags})

target_include_directories(${PROJECT_NAME}
    PRIVATE 
      $<BUILD_INTERFACE:${PROJECT_BINARY_DIR}/include>
      ${CMAKE_SOURCE_DIR}/include
      ${XML_INCLUDE_DIRS} 
      ${Boost_INCLUDE_DIR}
)

target_link_libraries(${PROJECT_NAME} PUBLIC ${Boost_LIBRARY_DIRS} ${XML_LIBRARIES})

#
# Library for LAS I/O support
#
add_library(LASReader ${LIBRARY_TYPE} 
  ${CMAKE_SOURCE_DIR}/src/LAS/LASReader.cpp
  ${CMAKE_SOURCE_DIR}/include/openE57/LAS/LASReader.h)

set_target_properties(LASReader PROPERTIES 
  DEBUG_POSTFIX "-d" 
  MSVC_RUNTIME_LIBRARY "${MSVC_RUNTIME_TYPE}")
target_compile_options(LASReader PUBLIC ${compiler_options})
target_compile_definitions(LASReader PUBLIC ${compiler_definitions})
target_link_options(LASReader PUBLIC ${linker_flags})

target_include_directories(LASReader
    PRIVATE 
      $<BUILD_INTERFACE:${PROJECT_BINARY_DIR}/include>
      ${CMAKE_SOURCE_DIR}/include
      ${XML_INCLUDE_DIRS}
      ${Boost_INCLUDE_DIR}
)

target_link_libraries(LASReader PUBLIC ${Boost_LIBRARY_DIRS} ${XML_LIBRARIES})

#
# Time conversion utilities
#
add_library(time_conversion ${LIBRARY_TYPE}
  ${CMAKE_SOURCE_DIR}/src/time_conversion/time_conversion.c
  ${CMAKE_SOURCE_DIR}/include/openE57/time_conversion/time_conversion.h
  ${CMAKE_SOURCE_DIR}/include/openE57/time_conversion/basictypes.h
  ${CMAKE_SOURCE_DIR}/include/openE57/time_conversion/constants.h
  ${CMAKE_SOURCE_DIR}/include/openE57/time_conversion/gnss_error.h)

set_target_properties(time_conversion PROPERTIES 
  DEBUG_POSTFIX "-d" 
  MSVC_RUNTIME_LIBRARY "${MSVC_RUNTIME_TYPE}")
target_compile_options(time_conversion PUBLIC ${compiler_options})
target_compile_definitions(time_conversion PUBLIC ${compiler_definitions})
target_link_options(time_conversion PUBLIC ${linker_flags})

target_include_directories(time_conversion 
    PRIVATE 
        $<BUILD_INTERFACE:${PROJECT_BINARY_DIR}/include>
        ${CMAKE_SOURCE_DIR}/include
)

target_link_libraries(time_conversion 
  PUBLIC 
    ${Boost_LIBRARY_DIRS}
    ${XML_LIBRARIES}
    $<$<OR:$<C_COMPILER_ID:GNU>,$<C_COMPILER_ID:Clang>>:dl>
    $<$<OR:$<C_COMPILER_ID:GNU>,$<C_COMPILER_ID:Clang>>:m>
    $<$<OR:$<C_COMPILER_ID:GNU>,$<C_COMPILER_ID:Clang>>:c>
)

if(${BUILD_EXAMPLES})
  add_subdirectory(${CMAKE_SOURCE_DIR}/examples)
endif()

if(${BUILD_TESTS})
  add_subdirectory(${CMAKE_SOURCE_DIR}/tests)
endif()

if(${BUILD_TOOLS})
  add_subdirectory(${CMAKE_SOURCE_DIR}/tools)
endif()


#
# Add Clang Format
#
include(${CMAKE_SOURCE_DIR}/cmake/clang_format.cmake)

# 
# Install Artifacts
#
install(
  TARGETS 
    ${PROJECT_NAME}
    LASReader
    time_conversion
  RUNTIME DESTINATION bin
  ARCHIVE DESTINATION lib)

install(
  FILES 
    ${CMAKE_SOURCE_DIR}/include/openE57/openE57.h
    ${CMAKE_SOURCE_DIR}/include/openE57/openE57Simple.h 
    ${CMAKE_BINARY_DIR}/opene57_export.h
  DESTINATION 
    include/openE57)

install(FILES  
  ${CMAKE_SOURCE_DIR}/CHANGELOG.md
DESTINATION .)

set(CPACK_PACKAGE_VENDOR "Michele Adduci <adduci@tutanota.com>")
set(CPACK_PACKAGE_VERSION_MAJOR "${${PROJECT_NAME}_MAJOR_VERSION}")
set(CPACK_PACKAGE_VERSION_MINOR "${${PROJECT_NAME}_MINOR_VERSION}")
set(CPACK_PACKAGE_VERSION_PATCH "${${PROJECT_NAME}_BUILD_VERSION}")
set(CPACK_SYSTEM_NAME "${${PROJECT_NAME}_BUILD_TAG}")
set(CPACK_GENERATOR "ZIP")
set(CPACK_STRIP_FILES "TRUE")

include(CPack)
